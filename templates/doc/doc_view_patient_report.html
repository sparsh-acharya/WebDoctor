{% extends "doc_base.html" %}

{% block content %}
<main class="flex-1 container mx-auto px-4 sm:px-6 lg:px-8 py-6 max-w-7xl">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div class="flex items-center space-x-4">
                <a href="{% url 'DOC_PAT_DETAIL' patient.id %}"
                    class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center hover:bg-gray-200 transition-all duration-200 shadow-sm">
                    <div class="w-5 h-5 flex items-center justify-center text-gray-600">
                        <i class="ri-arrow-left-line"></i>
                    </div>
                </a>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">{{ report.title }}</h1>
                    <p class="text-gray-500 text-sm mt-1">Medical Report for {{ patient.full_name }}</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center space-x-3">
                {% if report.uploaded_by == request.user %}
                <button
                    class="open-edit-report-modal w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center hover:bg-amber-200 transition-all duration-200 shadow-sm hover:shadow-md group relative"
                    title="Edit Report" data-report-id="{{ report.id }}">
                    <div class="w-5 h-5 flex items-center justify-center text-amber-700">
                        <i class="ri-edit-line"></i>
                    </div>
                    <div
                        class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-1.5 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-all duration-200 pointer-events-none whitespace-nowrap shadow-lg">
                        Edit Report
                    </div>
                </button>
                <button
                    class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center hover:bg-red-200 transition-all duration-200 shadow-sm hover:shadow-md group relative open-delete-report-modal"
                    data-report-title="{{ report.title }}" data-report-id="{{ report.id }}" title="Delete Report">
                    <div class="w-5 h-5 flex items-center justify-center text-red-700">
                        <i class="ri-delete-bin-line"></i>
                    </div>
                    <div
                        class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-1.5 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-all duration-200 pointer-events-none whitespace-nowrap shadow-lg">
                        Delete Report
                    </div>
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
        <!-- Main Content -->
        <div class="xl:col-span-3 space-y-6">
            <!-- Report Information Card -->
            <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-8">
                <div class="flex items-center mb-8">
                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center mr-4">
                        <div class="w-5 h-5 flex items-center justify-center text-blue-600">
                            <i class="ri-information-line"></i>
                        </div>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900">Report Information</h2>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div>
                            <label
                                class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Report
                                Type</label>
                            <p class="text-base font-medium text-gray-900">{{ report.get_report_type_display }}</p>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Test
                                Date</label>
                            <p class="text-base font-medium text-gray-900">{{ report.report_date|date:"F d, Y" }}</p>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Uploaded</label>
                            <p class="text-base font-medium text-gray-900">{{ report.uploaded_date|date:"F d, Y" }}</p>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <label
                                class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Uploaded
                                By</label>
                            <div class="flex items-center">
                                {% if report.uploaded_by %}
                                <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden mr-4 shadow-sm">
                                    <img src="https://readdy.ai/api/search-image?query=professional%20headshot%20of%20a%20{{ report.uploaded_by.first_name|lower }}%20person%2C%20healthcare%20consumer%2C%20medical%20patient%2C%20confident%20smile%2C%20studio%20lighting&width=200&height=200&seq={{ report.uploaded_by.id }}&orientation=squarish"
                                        alt="{{ report.uploaded_by.first_name }}" class="w-full h-full object-cover" />
                                </div>
                                <div>
                                    <p class="text-base font-semibold text-gray-900">{{ report.uploaded_by.first_name }}
                                        {{ report.uploaded_by.last_name }}</p>
                                    <p class="text-sm text-gray-500">{{ report.uploaded_by.email }}</p>
                                </div>
                                {% else %}
                                <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden mr-4 shadow-sm">
                                    <div class="w-full h-full flex items-center justify-center">
                                        <div class="w-5 h-5 flex items-center justify-center text-gray-400">
                                            <i class="ri-user-line"></i>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-base font-semibold text-gray-900">Unknown User</p>
                                    <p class="text-sm text-gray-500">No email available</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% if report.lab_facility %}
                        <div>
                            <label
                                class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Laboratory</label>
                            <p class="text-base font-medium text-gray-900">{{ report.lab_facility }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Description Card -->
            {% if report.description %}
            <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-8">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center mr-4">
                        <div class="w-5 h-5 flex items-center justify-center text-green-600">
                            <i class="ri-file-text-line"></i>
                        </div>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900">Description</h2>
                </div>
                <div class="bg-gray-50 rounded-xl p-6">
                    <p class="text-gray-700 text-base leading-relaxed">{{ report.description }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="xl:col-span-1">
            <!-- File Information Card -->
            {% if report.file %}
            <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6 sticky top-6">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center mr-4">
                        <div class="w-5 h-5 flex items-center justify-center text-orange-600">
                            <i class="ri-attachment-2"></i>
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900">File</h3>
                </div>

                <div class="bg-gray-50 rounded-xl p-5 mb-6">
                    <a href="{{report.file.url}}" target="_blank">
                        <div class="flex items-center space-x-4">
                            <div
                                class="w-12 h-12 bg-white rounded-xl flex items-center justify-center border border-gray-200 shadow-sm">
                                <div class="w-6 h-6 flex items-center justify-center text-gray-600">
                                    <i class="ri-file-line"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-semibold text-gray-900 truncate">{{ report.file.name|slice:"19:"}}</p>
                                <p class="text-xs text-gray-500 mt-1">{{ report.file.name|slice:"-4:"|upper }}</p>
                            </div>
                        </div>
                </div>
                </a>

                <a href="{% url 'DOC_DOWNLOAD_REPORT' patient.id report.id %}" target="_blank"
                    class="w-full inline-flex items-center justify-center px-4 py-3 bg-blue-600 text-white text-sm font-semibold rounded-xl hover:bg-blue-700 transition-all duration-200 shadow-sm hover:shadow-md">
                    <div class="w-4 h-4 flex items-center justify-center mr-2">
                        <i class="ri-download-line"></i>
                    </div>
                    Download File
                </a>
            </div>
            {% endif %}

            <!-- Patient Information Card -->
            <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-6 mt-6">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center mr-4">
                        <div class="w-5 h-5 flex items-center justify-center text-indigo-600">
                            <i class="ri-user-line"></i>
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900">Patient Info</h3>
                </div>

                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-500">Name</p>
                        <p class="text-gray-900 font-medium">{{ patient.full_name }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Age</p>
                        <p class="text-gray-900 font-medium">{{ patient.age|default:'N/A' }} years</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Blood Type</p>
                        <p class="text-gray-900 font-medium">{{ patient.blood_type|default:'N/A' }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Edit Report Modal -->
<div id="editReportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg border border-gray-100 max-h-[95vh] flex flex-col">
        <!-- Modal Header -->
        <div
            class="flex items-center justify-between p-6 border-b border-gray-100 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-t-2xl flex-shrink-0">
            <div class="flex items-center">
                <div class="w-10 h-10 flex items-center justify-center rounded-full bg-yellow-100 text-yellow-600 mr-3">
                    <i class="ri-edit-line text-xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Edit Report</h2>
                    <p class="text-sm text-gray-600">Update medical report for {{ patient.full_name }}</p>
                </div>
            </div>
            <button onclick="closeEditReportModal()"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-gray-800 transition-colors">
                <i class="ri-close-line text-lg"></i>
            </button>
        </div>

        <!-- Modal Body with Scroll -->
        <div class="p-6 overflow-y-auto flex-1">
            <form method="post" action="" id="editReportForm" enctype="multipart/form-data" class="space-y-4">
                {% csrf_token %}
                <div class="space-y-4" id="editFormFields">
                    <!-- Django form fields will be populated here -->
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-100">
                    <button type="button" onclick="closeEditReportModal()"
                        class="px-6 py-2.5 text-gray-700 bg-gray-100 hover:bg-gray-200 font-semibold rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all duration-200 flex items-center">
                        <i class="ri-close-line mr-2"></i>
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-6 py-2.5 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-all duration-200 flex items-center">
                        <i class="ri-save-line mr-2"></i>
                        Update Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden transition-opacity duration-200">
    <div id="deleteModalBox"
        class="bg-white rounded-2xl shadow-2xl p-0 w-full max-w-md border border-red-200 transform scale-95 opacity-0 transition-all duration-200">
        <div class="flex items-center px-6 py-4 rounded-t-2xl bg-red-50 border-b border-red-100">
            <div
                class="flex-shrink-0 h-12 w-12 flex items-center justify-center rounded-full bg-red-200 text-red-700 mr-4 shadow">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" fill="#fee2e2" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01" class="text-red-700"
                        stroke="#b91c1c" stroke-width="2" />
                </svg>
            </div>
            <div>
                <h3 class="text-xl font-bold text-red-700" id="deleteModalTitle">Delete Item</h3>
                <p class="text-gray-700 mt-1 text-sm" id="deleteModalText">Are you sure you want to delete this item?
                </p>
            </div>
        </div>
        <div class="px-6 py-6 flex flex-col sm:flex-row justify-end gap-3 bg-white rounded-b-2xl">
            <button type="button" id="cancelDeleteBtn"
                class="px-5 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400 transition">Cancel</button>
            <button type="button" id="confirmDeleteBtn"
                class="px-5 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-semibold shadow-sm border border-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 transition">Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block js_addon %}
<script>
    let formToDelete = null;
    let deleteUrl = null;
    const modal = document.getElementById('deleteModal');
    const modalBox = document.getElementById('deleteModalBox');
    const modalTitle = document.getElementById('deleteModalTitle');
    const modalText = document.getElementById('deleteModalText');

    // Report delete handlers
    document.querySelectorAll('.open-delete-report-modal').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            formToDelete = null;
            const reportTitle = btn.getAttribute('data-report-title');
            const reportId = btn.getAttribute('data-report-id');
            deleteUrl = `/doctor/patient/{{ patient.id }}/reports/${reportId}/delete`;
            modalTitle.textContent = 'Delete Report';
            modalText.textContent = `Are you sure you want to delete the report "${reportTitle}"?`;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalBox.classList.remove('scale-95', 'opacity-0');
                modalBox.classList.add('scale-100', 'opacity-100');
            }, 10);
        });
    });

    document.getElementById('cancelDeleteBtn').onclick = function () {
        modalBox.classList.remove('scale-100', 'opacity-100');
        modalBox.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            formToDelete = null;
            deleteUrl = null;
        }, 200);
    };

    document.getElementById('confirmDeleteBtn').onclick = function () {
        if (formToDelete) {
            formToDelete.submit();
        } else if (deleteUrl) {
            // Create a form for report deletion
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = deleteUrl;

            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            document.body.appendChild(form);
            form.submit();
        }

        modalBox.classList.remove('scale-100', 'opacity-100');
        modalBox.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 200);
    };

    // Optional: close modal on outside click
    modal.addEventListener('click', function (e) {
        if (e.target === this) {
            modalBox.classList.remove('scale-100', 'opacity-100');
            modalBox.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                formToDelete = null;
                deleteUrl = null;
            }, 200);
        }
    });

    // Edit Report Modal handlers
    document.querySelectorAll('.open-edit-report-modal').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const reportId = btn.getAttribute('data-report-id');

            // Fetch the Django form data from the server
            fetch(`/doctor/patient/{{ patient.id }}/reports/${reportId}/get-edit-form`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Set the form action URL
                        document.getElementById('editReportForm').action = `/doctor/patient/{{ patient.id }}/reports/${reportId}/edit`;

                        // Populate the form fields with Django form data
                        populateEditForm(data.form_data);

                        // Show the modal
                        document.getElementById('editReportModal').classList.remove('hidden');
                        document.body.style.overflow = 'hidden';
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error fetching form data:', error);
                    alert('Error loading form data');
                });
        });
    });

    function populateEditForm(formData) {
        const formFieldsContainer = document.getElementById('editFormFields');
        formFieldsContainer.innerHTML = ''; // Clear existing fields

        // Create form fields based on Django form data
        Object.keys(formData).forEach(fieldName => {
            const fieldData = formData[fieldName];
            const fieldDiv = document.createElement('div');

            // Create label
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium text-gray-700 mb-1';
            label.htmlFor = `edit_${fieldName}`;
            label.innerHTML = fieldData.label;
            if (fieldData.required) {
                label.innerHTML += ' <span class="text-red-500">*</span>';
            }

            // Create input field based on field type
            let input;
            if (fieldName === 'report_type') {
                input = document.createElement('select');
                input.className = 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary';
                if (fieldData.required) {
                    input.required = true;
                }

                // Add options
                const options = [
                    { value: '', text: 'Select report type' },
                    { value: 'BLOOD_TEST', text: 'Blood Test' },
                    { value: 'X_RAY', text: 'X-Ray' },
                    { value: 'MRI', text: 'MRI' },
                    { value: 'CT_SCAN', text: 'CT Scan' },
                    { value: 'ULTRASOUND', text: 'Ultrasound' },
                    { value: 'ECG', text: 'ECG' },
                    { value: 'ECHO', text: 'Echocardiogram' },
                    { value: 'BIOPSY', text: 'Biopsy' },
                    { value: 'PATHOLOGY', text: 'Pathology' },
                    { value: 'OTHER', text: 'Other' }
                ];

                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    if (option.value === fieldData.value) {
                        optionElement.selected = true;
                    }
                    input.appendChild(optionElement);
                });
            } else if (fieldName === 'report_date') {
                input = document.createElement('input');
                input.type = 'date';
                input.className = 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary';
                input.value = fieldData.value;
                if (fieldData.required) {
                    input.required = true;
                }
            } else if (fieldName === 'file') {
                input = document.createElement('input');
                input.type = 'file';
                input.className = 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary';
                input.accept = '.pdf,.jpg,.jpeg,.png,.doc,.docx';
                if (fieldData.required) {
                    input.required = true;
                }

                // Add help text for file field
                const helpText = document.createElement('p');
                helpText.className = 'mt-1 text-xs text-gray-500';
                helpText.textContent = 'Accepted formats: PDF, JPG, PNG, DOC, DOCX. Leave empty to keep the current file.';
                fieldDiv.appendChild(helpText);
            } else if (fieldName === 'description') {
                input = document.createElement('textarea');
                input.rows = 4;
                input.className = 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary resize-none';
                input.placeholder = 'Enter additional description or notes about the report';
                input.value = fieldData.value;
                if (fieldData.required) {
                    input.required = true;
                }
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.className = 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary';
                input.value = fieldData.value;
                input.placeholder = fieldData.label;
                if (fieldData.required) {
                    input.required = true;
                }
            }

            input.name = fieldName;
            input.id = `edit_${fieldName}`;

            // Append label and input to field div
            fieldDiv.appendChild(label);
            fieldDiv.appendChild(input);

            // Append field div to container
            formFieldsContainer.appendChild(fieldDiv);
        });
    }

    function openEditReportModal() {
        document.getElementById('editReportModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };
    function closeEditReportModal() {
        document.getElementById('editReportModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    };
</script>
{% endblock %}
