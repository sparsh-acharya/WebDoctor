{% extends "doc_base.html" %}

{% block content %}
<!-- Main Content -->
<main class="flex-1 container mx-auto px-4 py-6">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Requests</h1>
        <p class="text-gray-600">Below is a list of all requests from patients.</p>
    </div>
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-6 border-b border-gray-100 flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-900">All Requests</h2>

        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3">Patient</th>
                        <th scope="col" class="px-6 py-3">Note</th>
                        <th scope="col" class="px-6 py-3">Date</th>
                        <th scope="col" class="px-6 py-3">Status</th>
                        <th scope="col" class="px-6 py-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if requests %}
                    {% for request in requests %}
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">
                            {{request.patient.full_name|title}}</td>
                        <td class="px-6 py-4">{{request.notes|truncatechars:30}}</td>
                        <td class="px-6 py-4">{{request.request_date}}</td>
                        <td class="px-6 py-4"><span
                                class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full">{{request.get_request_status_display}}</span>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="acceptRequest('{{request.id}}')"
                                class="text-green-600 hover:text-green-900 mr-2"><i class="ri-check-line"></i>
                                Approve</button>
                            <button class="text-red-600 hover:text-red-900"><i class="ri-close-line"></i>
                                Reject</button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 text-center text-gray-500" colspan="5">
                            <div class="text-center py-4">
                                <p class="text-lg font-medium text-gray-900">You have no pending requests.</p>
                                <p class="text-sm text-gray-600">As soon as a patient sends a request, it will
                                    appear here.</p>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

    </div>
</main>
</div>
<!-- Toast Notification -->
<div id="toast"
    class="fixed top-4 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-4 transform translate-x-full transition-transform duration-300 z-50 max-w-sm">
    <div class="flex items-start">
        <div class="flex-shrink-0">
            <i id="toastIcon" class="text-lg"></i>
        </div>
        <div class="ml-3 flex-1">
            <p id="toastMessage" class="text-sm font-medium text-gray-900"></p>
        </div>
        <div class="ml-4 flex-shrink-0">
            <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600">
                <i class="ri-close-line"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block js_addon %}
<script>
    function acceptRequest(id) {

        const formData = new FormData();

        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch(`/doctor/request/${id}/approve`, {
            method: 'POST',
            body: formData,
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    // Refresh the page after a short delay to update button states
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(data.message, 'error');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            })
            .catch(error => {

                showToast('An error occurred. Please try again.', 'error');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            });
    }
    // Toast notification functions
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');

        toastMessage.textContent = message;

        // Set icon and colors based on type
        if (type === 'success') {
            toastIcon.className = 'ri-check-line text-green-500';
            toast.classList.add('border-green-200');
        } else if (type === 'error') {
            toastIcon.className = 'ri-error-warning-line text-red-500';
            toast.classList.add('border-red-200');
        } else {
            toastIcon.className = 'ri-information-line text-blue-500';
            toast.classList.add('border-blue-200');
        }

        // Show toast
        toast.classList.remove('translate-x-full');

        // Auto hide after 5 seconds
        setTimeout(() => {
            hideToast();
        }, 5000);
    }

    function hideToast() {
        const toast = document.getElementById('toast');
        toast.classList.add('translate-x-full');
        toast.classList.remove('border-green-200', 'border-red-200', 'border-blue-200');
    }
</script>
{% endblock %}
